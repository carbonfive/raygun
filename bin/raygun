#!/usr/bin/env ruby

require 'fileutils'
require 'securerandom'

def camelize(string)
  result = string.sub(/^[a-z\d]*/) { $&.capitalize }
  result.gsub(/(?:_|(\/))([a-z\d]*)/) { "#{$1}#{$2.capitalize}" }
end

def titleize(underscored_string)
  result = underscored_string.gsub(/_/, ' ')
  result.gsub(/\b('?[a-z])/) { $1.capitalize }
end

unless ARGV[0]
  puts "Please specify where raygun should generate a project (e.g. projects/my_new_project)."
  puts "usage: raygun new_app_directory"
  exit 1
end

app_dir  = ARGV[0]
app_name = File.basename(app_dir).gsub(/\s+/, '-')
app_name_dash  = app_name.gsub('_', '-')
app_name_snake = app_name.gsub('-', '_')
app_name_camel = camelize(app_name_snake)
app_name_title = titleize(app_name_snake)

ruby_version_patchlevel = `ruby -e 'print "#{RUBY_VERSION}-p#{RUBY_PATCHLEVEL}"'`
ruby_version            = `ruby -e 'print "#{RUBY_VERSION}"'`

puts
puts "Creating new app #{app_name_camel} in directory #{app_dir}..."
puts

FileUtils.cp_r(File.expand_path('../../app_prototype', __FILE__), app_dir)

Dir.chdir(app_dir) do
  `find . -type f -print | xargs sed -i '' 's/AppPrototype/#{app_name_camel}/g'`
  `find . -type f -print | xargs sed -i '' 's/app-prototype/#{app_name_dash}/g'`
  `find . -type f -print | xargs sed -i '' 's/app_prototype/#{app_name_snake}/g'`
  `find . -type f -print | xargs sed -i '' 's/App Prototype/#{app_name_title}/g'`
  `sed -i '' 's/SUPER_SECRET_TOKEN_REPLACE_ME_TODO/#{SecureRandom.hex(128)}/' config/initializers/secret_token.rb`
  `sed -i '' 's/1.9.3-p327/#{ruby_version_patchlevel}/g' .rvmrc .ruby-version`
  `sed -i '' 's/1.9.3/#{ruby_version}/g' Gemfile`

  puts "Done! Next steps..."
  puts ""
  puts "# Install updated dependencies"
  puts "$ cd #{ARGV[0]}"
  puts "$ gem install bundler"
  puts "$ bundle update"
  puts ""
  puts "# Prepare the database: schema and reference / sample data"
  puts "$ rake db:setup db:sample_data"
  puts ""
  puts "# Run the specs (they should all pass)"
  puts "$ rake"
  puts ""
  puts "# Load reference and sample data, then run the app and check things out"
  puts "$ foreman start"
  puts "$ open http://0.0.0.0:3000"
  puts ""
  puts "Enjoy your Carbon Five flavored Rails application!"
end
